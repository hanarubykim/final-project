---
title: "Data Compilation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(readxl)
library(janitor)
library(openxlsx)
library(rstanarm)
library(ggdist)
library(broom.mixed)
library(ggthemes)
```

```{r}
# table will be the starting framework containing the relevant subgroups so that
# I can join data across grades from their respective sheets from the Excel

table <- read_excel(path = "raw_data/NYC_GEOG_DIST_1.xlsx",
                    sheet = 3,
                    skip = 1) %>%
  clean_names() %>%
  select(subgroup)

# filepaths contains the list of paths needed to access the data of all 32
# districts

filepaths = list("raw_data/NYC_GEOG_DIST_1.xlsx",
                 "raw_data/NYC_GEOG_DIST_2.xlsx",
                 "raw_data/NYC_GEOG_DIST_3.xlsx",
                 "raw_data/NYC_GEOG_DIST_4.xlsx",
                 "raw_data/NYC_GEOG_DIST_5.xlsx",
                 "raw_data/NYC_GEOG_DIST_6.xlsx",
                 "raw_data/NYC_GEOG_DIST_7.xlsx",
                 "raw_data/NYC_GEOG_DIST_8.xlsx",
                 "raw_data/NYC_GEOG_DIST_9.xlsx",
                 "raw_data/NYC_GEOG_DIST_10.xlsx",
                 "raw_data/NYC_GEOG_DIST_11.xlsx",
                 "raw_data/NYC_GEOG_DIST_12.xlsx",
                 "raw_data/NYC_GEOG_DIST_13.xlsx",
                 "raw_data/NYC_GEOG_DIST_14.xlsx",
                 "raw_data/NYC_GEOG_DIST_15.xlsx",
                 "raw_data/NYC_GEOG_DIST_16.xlsx",
                 "raw_data/NYC_GEOG_DIST_17.xlsx",
                 "raw_data/NYC_GEOG_DIST_18.xlsx",
                 "raw_data/NYC_GEOG_DIST_19.xlsx",
                 "raw_data/NYC_GEOG_DIST_20.xlsx",
                 "raw_data/NYC_GEOG_DIST_21.xlsx",
                 "raw_data/NYC_GEOG_DIST_22.xlsx",
                 "raw_data/NYC_GEOG_DIST_23.xlsx",
                 "raw_data/NYC_GEOG_DIST_24.xlsx",
                 "raw_data/NYC_GEOG_DIST_25.xlsx",
                 "raw_data/NYC_GEOG_DIST_26.xlsx",
                 "raw_data/NYC_GEOG_DIST_27.xlsx",
                 "raw_data/NYC_GEOG_DIST_28.xlsx",
                 "raw_data/NYC_GEOG_DIST_29.xlsx",
                 "raw_data/NYC_GEOG_DIST_30.xlsx",
                 "raw_data/NYC_GEOG_DIST_31.xlsx",
                 "raw_data/NYC_GEOG_DIST_32.xlsx")
```


```{r, cache = TRUE, message = FALSE}
# Creating a function to compile the 32 files worth of data into one tibble

grade_proficiency <- function(filepaths, table){
  
  # Accessing data from all 32 NYC Districts

  for(i in 1:length(filepaths)){
    
    # Accessing data for the performance of grades 3-8 for every district grade
    # 3 starts on the second sheet of every Excel 
    
    # leaving out sheets 1 and 8 for irrelevant data
    
    for(grade in c(2,3,4,5,6,7,9,10,11,12,13,14)){
      
      # Will use grade_num to label the columns by respective grade and allow
      # for cleaner merging later with respective district data
      # Separating data on ELA tests and math tests with suffix in column name
      
      if(grade < 8){
        grade_num = paste("g", grade + 1, "_ela", sep = "")
      } else {
        grade_num = ifelse(grade == 8, "", paste("g", grade - 6, "_math", sep = ""))
      }
      
      # Accessing data from specific grade
      
      information <- read_excel(path = paste(filepaths[i]),
                                sheet = grade,
                                skip = 1) %>%
        clean_names() %>%
        
        # percent_13 contains the data of a grade for the percentage of each
        # racial group that scored "proficient" on the state exam
        
        select(subgroup, percent_13) %>%
        rename(!!grade_num := percent_13)
      
      if(grade == 2){
        current_table <- table %>%
          left_join(information, by = "subgroup") 
      } else {
        current_table <- current_table %>%
          left_join(information, by = "subgroup") 
      }

    }
    current_table <- current_table %>%
      mutate(district = paste(i)) %>%
      filter(subgroup %in% c("All Students", "American Indian or Alaska Native", "Asian or Native Hawaiian/Other Pacific Islander", "Black or African American",
                             "Hispanic or Latino", "White", "Multiracial"))
    
    if(i == 1){
      new_table <- current_table
    } else {
      new_table <- new_table %>%
        full_join(current_table)
    }
  }
  return(new_table)
}


data <- grade_proficiency(filepaths, table) %>%
  filter(across(everything(), ~ !grepl("—", .))) %>%
  filter(!subgroup == "Multiracial") %>%
  drop_na() %>%
  mutate_each(funs(as.numeric(gsub("%", "", ., fixed = TRUE))/100), -subgroup)

data
test_data <- data

```

```{r}
# Plotting average proficiency data by grade per district

data %>%
  
  # Recognizing -- values as NA
  
  filter(across(everything(), ~ !grepl("—", .))) %>%
  drop_na() %>%
  
  # Mutating percentage strings as doubles
  
  mutate_each(funs(as.numeric(gsub("%", "", ., fixed = TRUE))/100), -subgroup) %>%
  group_by(district) %>%
  summarize_all(mean) %>%
  select(district:g8_ela, -subgroup) %>%
  pivot_longer(names_to = "grade_test",
               values_to = "proficiency",
               cols = -district) %>%
  # group_by(grade_test) %>%
  # summarize_all(mean) %>%
  # ungroup() %>%
  ggplot(mapping = aes(x = grade_test, y = proficiency, group = district)) +
  geom_point() +
  geom_line() + 
  labs(title = "Average proficiency on ELA tests by grade for each district",
       x = "Grade",
       y = "Proficiency") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```


```{r}
# Finding how the average proficiency on tests by race group change over time
# and where it divulges from the average and from other race groups

data %>%
  
  # Recognizing -- values as NA
  
  filter(across(everything(), ~ !grepl("—", .))) %>%
  filter(!subgroup == "Multiracial") %>%
  drop_na() %>%
  
  # Mutating percentage strings as doubles
  
  mutate_each(funs(as.numeric(gsub("%", "", ., fixed = TRUE))/100), -subgroup) %>%
  group_by(subgroup) %>%
  summarize_all(mean) %>%
  select(subgroup:g8_ela) %>%
  ungroup() %>%
  mutate(subgroup = as.factor(subgroup)) %>%
  # Trying to pivot wider to have subgroups and consequent grade scores
  pivot_longer(names_to = "grade_test",
               values_to = "proficiency",
               cols = g3_ela:g8_ela) %>%
  ggplot(mapping = aes(x = grade_test,
                       y = proficiency,
                       group = subgroup,
                       color = subgroup)) +
  geom_line() +
  scale_x_discrete(labels = c("3", "4", "5", "6", "7", "8")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(title = "Average Proficiencies on 2018 ELA Tests by Grade",
       subtitle = "",
       x = "Grade",
       y = "Proficiency",
       caption = "Source: ",
       fill = "Subgroup")
  
```

```{r}
test_data <- data %>%
  select(-district) %>%
  pivot_longer(cols = g3_ela:g8_math,
               names_to = "test",
               values_to = "proficiency")

deviation <- stan_glm(data = test_data,
                      formula = proficiency ~ subgroup,
                      family = gaussian,
                      seed = 3,
                      refresh = 0)
test_data
newobs = tibble(subgroup = c("All Students", "American Indian or Alaska Native","Asian or Native Hawaiian/Other Pacific Islander", "Black or African American", "Hispanic or Latino", "White", "All Students"))

pe <- posterior_epred(deviation,
                      newdata = newobs) %>% 
  as_tibble() %>%
  set_names(newobs$subgroup)

plot_data <- pe %>%
  pivot_longer(names_to = c("Subgroup"),
               values_to = "Proficiency",
               cols = everything()) %>%
  filter(!Subgroup == "All Students")
  
  

plot_3 <- plot_data %>%
  ggplot(aes(x = Proficiency, y = fct_reorder(Subgroup, Proficiency),
             fill = "black")) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  stat_slab() + 
  theme_light() +
  theme(legend.position = "none") +
  labs(title = "Looking at Race as an Indication of Performance on\nState Test Results",
       x = "Proficiency Rates",
       y = "",
       caption = "Source: NYSED (2018)",
       fill = "Subgroup")

plot_3
```
```{r}
data_3 <- data %>%
  select(-district) %>%
  pivot_longer(cols = g3_ela:g8_math,
               names_to = c("grade", "test"),
               names_sep = "_",
               values_to = "proficiency") %>%
  mutate_each(funs(as.numeric(gsub("g", "", ., fixed = TRUE))), -c("subgroup", "test", "proficiency"))


data_3_fit <- stan_glm(data = data_3,
                       formula = proficiency ~ grade*subgroup,
                       family = gaussian,
                       seed = 3,
                       refresh = 0)

grade <- c(3, 4, 5, 6, 7, 8)
subgroup <- c("All Students", "American Indian or Alaska Native","Asian or Native Hawaiian/Other Pacific Islander", "Black or African American", "Hispanic or Latino", "White", "All Students")

newobs_3 <- expand_grid(grade, subgroup) %>%
  mutate(names = paste(grade, subgroup, sep = "_"))

newobs_3
pe_3 <- posterior_epred(data_3_fit,
                      newdata = newobs_3) %>% 
  as_tibble() %>%
  set_names(newobs_3$names)

plot_data_3 <- pe_3 %>%
  pivot_longer(names_to = c("Grade", "Subgroup"),
               names_sep = "_",
               values_to = "Proficiency",
               cols = everything()) %>%
  filter(!Subgroup == "All Students")
plot_data_3

plot_data_3 %>%
  ggplot(aes(x = Proficiency, y = fct_reorder(Subgroup, Proficiency),
             fill = Grade)) +
  stat_slab() +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(title = "Expected Peformance on State Test Results\nOver Time",
       x = "Proficiency Rates",
       y = "",
       caption = "Source: NYSED (2018)",
       fill = "Subgroup") +
  theme_light()
  
```

```{r}




```

